<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheely - Iniciar Sesi√≥n</title>
    <link rel="stylesheet" href="css/wheely_login.css">
</head>
<body>
    <div class="black-stripe"></div>

    <div class="logo">
        <img src="img/logo.png" alt="Logo de Wheely" style="width: 100px; height: auto; display: block; margin: 0 auto;">
    </div>

    <div class="container">
        <div class="welcome-section">
            <h1 class="welcome-title">Bienvenido a <span class="brand-name">Wheely</span></h1>
            <p class="welcome-subtitle">"Planea tu viaje, reporta y colabora"</p>
            <p class="welcome-description">
                Wheely es una plataforma web dise√±ada para mejorar la experiencia del
                transporte colectivo en Tuxtla Guti√©rrez.<br>
                Permite a los ciudadanos acceder de forma gratuita a informaci√≥n
                completa sobre rutas, paradas, horarios y tiempos de espera promedio del
                transporte p√∫blico local.
            </p>
        </div>
        <div class="left-image">
            <img src="img/image-removebg-preview (10).png" alt="Imagen de la Parada" height="90%" width="90%">
        </div>

        <div class="login-section">
            <div class="login-card">
                <button class="close-btn" onclick="goBack()" aria-label="Cerrar">&times;</button>

                <h2 class="login-title">Inicia sesi√≥n</h2>

                <!-- Indicador de carga -->
                <div id="loading-indicator" class="loading-hidden">
                    <div class="loading-spinner"></div>
                    <p>Verificando credenciales...</p>
                </div>

                <form class="login-form" onsubmit="handleLogin(event)" id="loginForm">
                    <div class="form-group">
                        <label class="form-label">
                            Ingresa tu email
                            <span class="required-mark">*</span>
                        </label>
                        <input
                            type="email"
                            class="form-input"
                            placeholder="usuario@gmail.com"
                            required
                            id="emailInput"
                            autocomplete="email">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Ingresa tu contrase√±a
                            <span class="required-mark">*</span>
                        </label>
                        <div class="password-wrapper">
                            <input
                                type="password"
                                class="form-input"
                                placeholder="Contrase√±a"
                                id="passwordInput"
                                required
                                autocomplete="current-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('passwordInput', this)">
                                <span class="emoji-icon">üôà</span>
                            </button>
                        </div>
                    </div>

                    <a href="#" class="forgot-password" onclick="handleForgotPassword(event)">Olvid√© mi contrase√±a</a>

                    <button type="submit" class="login-btn" id="loginButton">Ingresa</button>
                </form>
                
                <!-- Mensajes de error y √©xito -->
                <div id="message-container">
                    <p id="errorMessage" class="message error-message"></p>
                    <p id="successMessage" class="message success-message"></p>
                </div>

                <!-- Enlace de registro -->
                <div class="register-link">
                    <p>¬øNo tienes cuenta? <a href="wheely_register.html">Reg√≠strate aqu√≠</a></p>
                </div>
            </div>
        </div>
    </div>

    <script>
                // Configuraci√≥n de la API
        const API_CONFIG = {
            baseURL: 'http://localhost:7000',
            endpoints: {
                login: '/usuarios/login'
            }
        };

        // Variables globales
        let isLoading = false;

        // Funci√≥n para alternar visibilidad de contrase√±a
        function togglePassword(inputId, button) {
            const passwordInput = document.getElementById(inputId);
            const emojiSpan = button.querySelector(".emoji-icon");

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                emojiSpan.textContent = 'üôâ';
            } else {
                passwordInput.type = 'password';
                emojiSpan.textContent = 'üôà';
            }
        }

        // Funci√≥n para mostrar/ocultar loading
        function toggleLoading(show) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const loginForm = document.getElementById('loginForm');
            const loginButton = document.getElementById('loginButton');

            isLoading = show;

            if (show) {
                loadingIndicator.classList.remove('loading-hidden');
                loadingIndicator.classList.add('loading-visible');
                loginForm.style.opacity = '0.6';
                loginButton.disabled = true;
                loginButton.textContent = 'Verificando...';
            } else {
                loadingIndicator.classList.remove('loading-visible');
                loadingIndicator.classList.add('loading-hidden');
                loginForm.style.opacity = '1';
                loginButton.disabled = false;
                loginButton.textContent = 'Ingresa';
            }
        }

        // Funci√≥n para mostrar mensajes
        function showMessage(message, type = 'error') {
            clearMessages();
            
            const messageElement = document.getElementById(type === 'error' ? 'errorMessage' : 'successMessage');
            messageElement.textContent = message;
            messageElement.style.display = 'block';

            // Auto-ocultar mensaje despu√©s de 5 segundos
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n para limpiar mensajes
        function clearMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Funci√≥n para validar formato de email
        function isValidEmail(email) {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return emailRegex.test(email);
        }

        // Funci√≥n principal de login
        async function handleLogin(event) {
            event.preventDefault();

            if (isLoading) return;

            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            // Limpiar mensajes previos
            clearMessages();

            // Validaciones del lado del cliente
            if (!email || !password) {
                showMessage('Por favor, completa todos los campos.', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                showMessage('Por favor, ingresa un email v√°lido.', 'error');
                return;
            }

            if (password.length < 1) {
                showMessage('La contrase√±a es requerida.', 'error');
                return;
            }

            // Mostrar loading
            toggleLoading(true);

            try {
                console.log('Enviando datos de login a:', `${API_CONFIG.baseURL}${API_CONFIG.endpoints.login}`);
                console.log('Datos enviados:', { email, password: '***' });
                
                // Realizar petici√≥n de login
                const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.login}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                console.log('Status de respuesta:', response.status);
                console.log('Headers de respuesta:', response.headers);
                
                // Verificar si la respuesta es JSON v√°lida
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('La respuesta no es JSON v√°lida. Content-Type: ' + contentType);
                }
                
                const data = await response.json();
                console.log('Datos recibidos completos:', data);

                if (response.ok && data.success) {
                    // Login exitoso
                    const userData = data.data;
                    console.log('Login exitoso, datos del usuario:', userData);
                    
                    // Guardar datos del usuario en localStorage
                    const userDataToStore = {
                        id: userData.idUsuario,
                        name: userData.nombre,
                        email: userData.email,
                        loginTime: new Date().getTime()
                    };
                    
                    localStorage.setItem('wheelyUser', JSON.stringify(userDataToStore));
                    console.log('Usuario guardado en localStorage:', userDataToStore);

                    // Mostrar mensaje de √©xito
                    showMessage('¬°Login exitoso! Redirigiendo...', 'success');

                    // Redirigir despu√©s de un breve delay
                    setTimeout(() => {
                        window.location.href = 'wheely_log_register.html';
                    }, 1500);

                } else {
                    // Login fallido
                    console.error('Login fallido. Respuesta completa:', {
                        status: response.status,
                        data: data
                    });
                    
                    let errorMessage = 'Email o contrase√±a incorrectos';
                    if (data.message) {
                        errorMessage = data.message;
                    }
                    
                    showMessage(errorMessage, 'error');
                }

            } catch (error) {
                console.error('Error durante el login:', error);
                
                // Verificar diferentes tipos de errores
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showMessage('No se pudo conectar con el servidor. Verifica que el servidor est√© ejecut√°ndose en http://localhost:7000', 'error');
                } else if (error.name === 'SyntaxError' || error.message.includes('JSON')) {
                    showMessage('Error en la respuesta del servidor. El servidor puede no estar devolviendo JSON v√°lido.', 'error');
                } else if (error.message.includes('Content-Type')) {
                    showMessage('El servidor no est√° devolviendo una respuesta JSON v√°lida. Verifica la configuraci√≥n del backend.', 'error');
                } else {
                    showMessage('Error: ' + error.message, 'error');
                }
            } finally {
                // Ocultar loading
                toggleLoading(false);
            }
        }

        // Funci√≥n para manejar "olvid√© mi contrase√±a"
        function handleForgotPassword(event) {
            event.preventDefault();
            showMessage('Funcionalidad de recuperaci√≥n de contrase√±a pr√≥ximamente disponible.', 'error');
        }

        // Funci√≥n para volver atr√°s
        function goBack() {
            window.location.href = 'wheely_welcome.html';
        }

        // Funci√≥n para verificar si el usuario ya est√° logueado
        function checkExistingLogin() {
            const userData = localStorage.getItem('wheelyUser');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    const loginTime = user.loginTime;
                    const currentTime = new Date().getTime();
                    const timeDiff = currentTime - loginTime;
                    
                    // Si el login fue hace menos de 24 horas, redirigir autom√°ticamente
                    if (timeDiff < 24 * 60 * 60 * 1000) {
                        showMessage('Ya tienes una sesi√≥n activa. Redirigiendo...', 'success');
                        setTimeout(() => {
                            window.location.href = 'wheely_log_register.html';
                        }, 2000);
                        return true;
                    } else {
                        // Limpiar datos expirados
                        localStorage.removeItem('wheelyUser');
                    }
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    localStorage.removeItem('wheelyUser');
                }
            }
            return false;
        }

        // Funci√≥n para manejar Enter en los campos
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isLoading) {
                const form = document.getElementById('loginForm');
                form.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        }

        // Inicializaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('P√°gina de login cargada');
            
            // Verificar si ya est√° logueado
            if (checkExistingLogin()) {
                return;
            }

            // Configurar event listeners
            document.getElementById('emailInput').addEventListener('keypress', handleKeyPress);
            document.getElementById('passwordInput').addEventListener('keypress', handleKeyPress);

            // Animaci√≥n de entrada de los elementos del formulario
            const formGroups = document.querySelectorAll('.form-group');
            formGroups.forEach((group, index) => {
                group.style.opacity = '0';
                group.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    group.style.transition = 'all 0.6s ease';
                    group.style.opacity = '1';
                    group.style.transform = 'translateY(0)';
                }, 300 + (index * 100));
            });

            // Focus autom√°tico en el campo de email despu√©s de las animaciones
            setTimeout(() => {
                document.getElementById('emailInput').focus();
            }, 1000);
            
            // Verificar conexi√≥n con el servidor
            checkServerConnection();
        });

        // Funci√≥n para verificar conexi√≥n con el servidor
        async function checkServerConnection() {
            try {
                console.log('Verificando conexi√≥n con el servidor...');
                const response = await fetch(`${API_CONFIG.baseURL}/`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    console.log('‚úÖ Conexi√≥n con servidor exitosa');
                } else {
                    console.warn('‚ö†Ô∏è Servidor responde pero con estado:', response.status);
                }
            } catch (error) {
                console.error('‚ùå No se pudo conectar con el servidor:', error);
                showMessage('Advertencia: No se pudo verificar la conexi√≥n con el servidor. Aseg√∫rate de que est√© ejecut√°ndose en http://localhost:7000', 'error');
            }
        }

        // Manejar visibilidad de la p√°gina (para limpiar mensajes al volver)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                clearMessages();
            }
        });
    </script>